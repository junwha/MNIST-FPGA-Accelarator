#include "mnist.h"

//D_TYPE C_ARR[64][64], A_ARR[64][128], B_ARR[128][64];


/* 64*128, 128*64 transpose -> 128*64, 128*64
 * A: 32, 32, 32 ... <- 256
 * B: 32, 32, 32 ... <- 256
 * A: Merge |32|32|32|32|
 * B: Merge |32|32|32|32|
 * A[i] ^ B[i] -> D[i]
 * D[i] -> loop: cntNeg += D[i] % 2 -> D[i] >>= 1
 * cntNeg*-1+(128-cntNeg)
 * result in C[i]
 *
 * 1+-1 => 0
 *SG
 * 64*64 */


void load(D_TYPE *target, AXI_VAL *source)
{
for (int i=0; i<BATCH_SIZE*25; i++){
#pragma HLS PIPELINE
		target[i] = pop_stream<D_TYPE>(source[i]);
}
}

void store(AXI_VAL *target, D_TYPE *source)
{

	for (int i=0; i<BATCH_SIZE*10-1; i++)
	{
#pragma HLS PIPELINE
		target[i] = push_stream<D_TYPE>(source[i], 0);
	}
	target[639] = push_stream<D_TYPE>(source[BATCH_SIZE*10-1], 1);
}

void network(D_TYPE *X0, D_TYPE *X3)
{
	const char pop_count1[256] = {0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 4, 5, 5, 6, 5, 6, 6, 7, 5, 6, 6, 7, 6, 7, 7, 8};
	static const int fc1w[3200] ={1369938329, 338570864, -845142467, -1054071333, 1476599616, 1328019041, -1329660836, 2146265097, -603289273, -1068219714, 174245824, 504823303, -938215302, -2078286600, -1510148166, -809503608, -125953119, -2116016640, 444957119, -1733616385, -1416098909, -715728152, -369777661, 463996938, 292225023, -1811949995, -304770187, -48476946, 400286596, 2141421584, -103481325, -1001389777, -654311031, 1245840977, 1071772095, -15681537, -407404916, 944187535, -1292204045, -1843389695, 27656387, 2022845441, -15568641, -1069020178, 723386689, -770502640, -731865641, 621971001, 1180194769, -793116673, -2126978181, -213061649, -52169678, -765638144, 465033281, 1080908163, -1678321917, -755188048, -1149204532, -1795287185, -1613951279, -24840930, -1057758979, -990109727, -907413493, 255823088, 1998868225, 537069571, -1067909112, 157843458, 2075787435, 566496915, -88657492, -161612303, 2042101759, -1270124190, -857560678, -709824569, 1000803470, -1904534031, -1560435602, 521815074, -1055397846, -533716584, 20075968, 682790914, 61800945, -317682164, -24383153, -1644294211, -540939084, -933070690, 349953346, -1488044004, -2063644293, -542910651, -45686054, 260065211, -1987468878, 488636415, 2081330708, -877302857, -1288291138, 1754296419, -1582158862, 1474408513, 115888386, -1737514493, 1542354559, 2136944127, -721864708, -1458325759, -6733777, -57147144, -1140846801, -805102764, -2139146112, 184481927, -244005905, -2006155280, 240122969, -739588053, -1616982915, 2012612027, -700710913, 461833499, 1819134904, -237097948, -799217912, -1917111918, 225746931, 1493434174, 70383350, -998709521, -2105540929, 836631543, 1063123186, -2120810751, -862650978, 1343160412, -1794620304, -2059131584, 220233088, 1060229122, -657241253, -1031004716, 360283726, 652732300, -1622563766, 1489764351, 1785978177, -115888059, 1029926384, -2143841151, -938568687, 682640762, 552724473, 394985208, 16773498, -1610846977, -2437121, 1340997235, 256295528, -335883134, -1060281015, 472319312, 41965120, 124335104, -1068744704, 1346474544, -1569015786, -2013574153, 534094520, -158144740, -1453916161, -191566002, 1803932523, 799199427, -127751772, 1393466304, 124624852, 1112014596, 2059379739, 1072988625, -225943952, 315595778, -94662593, -430829774, -666771953, 1547682025, 66060996, 1875005507, -399994874, -738834940, -1113390772, -338158440, -2066379901, -1879656575, -17204580, 1744306175, 1421578769, -830108138, -476573882, 1352452662, -159764737, -761774087, -1409148949, -872364007, 33352, 55376, 39687039, 1976877053, 975175264, 939505923, -404274533, 1050740477, -1432440608, 851270207, 2124507791, -1434609825, -884159005, -24894587, 101091463, -932555992, 1749614591, -1375215011, 1845781616, -1830859628, 600384128, -13188289, -559808644, 677363842, 1206394943, 2130720915, -530770329, 1324494840, -9388897, -511049602, -2009332254, 1275599908, -2079719048, 3684753, -1513582867, -1267154945, -788267034, -874512626, 414693613, -1397473215, 1424279905, 544538623, 991133190, -1290254521, -516185071, -107974561, -783891276, 60125948, 2018902004, -1543504157, -537427975, -523513409, -160682152, 1406476, 456392793, -805092650, 1040219224, 25675720, 8249570, 404215911, -1492353028, 1650409183, -874285793, -1610840537, 2013197704, -623229588, 1147469823, 843646705, 814654550, 1075066546, -1204640857, 182888191, 1662746623, 163617703, 723769798, -851968254, -762331024, 1648197854, 66117088, 369114112, 255975472, 541851934, -536842663, -1065615364, 199688179, 2106916863, -1315831812, -1874853902, 272623828, -1604140909, -1739725098, -1843462145, -732010307, -752539560, -310358476, -809745617, -537246849, -285310713, -1567621028, 1363152987, -1577037344, 2099272, 705103837, -773896194, 1212284891, 729741364, -408975297, 175745145, -1897249937, 2079824275, -140045771, 717104508, 2136870545, -918543029, -1920975091, 1646507826, 1388969983, 223484502, 352677378, 1381825231, -267181313, -1875738882, 647796687, -1730646796, 842432258, -306201929, 66551904, 1901559815, 141459560, 39325568, 822112256, 1347354905, -1478487526, 1591270895, -201875483, -6686451, -145902339, -451055803, 1310660759, -165274893, -1169745007, -1268121601, 307748307, -1699914012, 1742331898, 1344533854, 2057850940, 44767595, -1043005476, 1192442836, 2096428023, -2018658436, 2143792067, 503436412, 117133310, 60930150, -805119810, 1147136, 8944980, 454580736, 547246088, 1214120961, -1477170861, 1976950912, -1073786545, 870441247, -2033975297, 1492201982, -610871037, 1305570011, 129469697, 919631368, 1001632736, -1694163450, 1557300547, 1616258385, 26753537, 516869951, -532022161, -2120676355, 259393494, 188808200, -2146810363, 95043208, 422027392, 433387565, 208159299, 2072905508, -68678122, 1609793374, -137185996, -337313793, 1813124668, -1399316073, -2012018862, -1743750625, 84482533, 116002810, 1585905562, -2138572302, 1228927542, 732205189, 528675438, 843099376, 1740630032, 92143624, -706212587, -33254305, 1079919612, 263663552, 1607970304, -1603546886, -384924998, 1366071853, -1589471077, -1914726568, 156565503, -538743133, 1858843295, 1323874901, 614300489, 923825896, -2025681974, 1655849703, 1918777362, 1140802477, -344184012, -1076543289, -22552321, -301068301, 8781468, 946856430, -2013658124, 705189440, 134345728, 1304891943, 773068112, 1150765822, -1609451875, 1986747387, 1618917522, -1359085569, 524170346, 541072151, -1252890914, -1436807092, 426892286, 1281077857, 576315272, -608171752, 2121098141, -1199810283, 803409347, -5111299, -664125706, 1489493506, 1455288842, 2147355823, -11278273, -208480013, 751143296, -190736602, -1736080935, -2067776199, -1565750826, 1574713328, -1243480065, 339613354, 1683031856, 69441333, -1034653340, -2042202132, 1129308215, -1495531031, 465862461, 1577054828, 268357888, -308877272, 184550913, 1183902365, 147075538, -1989157469, -1166837266, 105208488, -928639158, -566641997, -257819139, 2054946496, -11141108, 1207969708, -1978575895, 711458815, 349568080, 461627945, -1980228840, -2312449, -58081313, -654973447, 1209793421, -2111173380, -1730089272, 33681280, 537421830, -1969487630, 595593089, -402524944, -1199622363, -1008635696, -1116272145, -541979137, -28791811, -2127835530, 820872143, 2028982520, 401080657, 1035936026, 1395064831, -1498100737, -1309138983, 2038065037, -1802523946, -1938113880, -52266366, -306956287, 263970937, -1057161092, -808444155, 1061669123, -47460225, -1013151750, -664750189, -1465917411, -1058012800, 50493760, 606121986, -925218809, 100966767, 2078018906, 1598305582, -35243598, -47613484, -805699585, -689124049, 884029742, 513212925, -14598545, -54176001, 319680484, -1392903031, 2109992993, 4179248, 33341056, 508379145, 951779592, 854094405, 1607281775, -264948814, 36111444, -1682473071, -581071809, -481765921, 1133411287, -1384152803, 2072849638, -305533538, -2009873714, -344391681, -1627848665, -425477186, 1708544954, -205019134, -75004979, -139455181, -1995570568, -1869928006, 835263536, -66716745, -130099713, -1952961027, 676859520, -524134399, -1202782040, 467678819, -702889994, -1472621082, -1721899274, -1876533384, 1445330563, -915710699, 611266895, 771487516, -1596194817, -1878531738, -1294478233, 935356792, 970428624, 1462301706, 607391805, -824212368, -1080426778, 1151465785, 525288355, -31821761, -2141914200, 26523942, 1420363001, 1624276772, 1478742473, 18883528, -217890595, 1266798148, 299462593, -864322044, 67079734, -10498808, 78727916, 692322303, 1980737308, -630250933, -1577072189, 666827969, -1696726812, 1198130112, 497319682, 2355243, 540279114, -1490668069, 66943720, 1065096197, -55156609, 1708796947, 1936924750, 2139712624, -1140815033, -1269862275, 1427417080, -1412006238, 1131100229, 2016714733, 1923215166, 798391227, -618528769, 387682194, -1824811502, -377774677, 1544590918, 622778616, 1156890432, 2072531969, -641516452, -729857087, 66868684, 2145811303, -251756673, 1319931858, -1911980957, -150777766, -1071103198, 1104864, 8706144, 183350538, -1221174057, -2099174129, -1075574872, 2146823955, 1610463832, -809304065, -563803091, -386896178, -853617142, 145822272, 453675073, 1591780591, -1553203511, -757305951, -5046290, -534808258, 1073561426, -46073092, -692672668, 1737219755, 1479247954, -931331536, 1419802242, 134963200, 153526272, 671121684, -177763188, -1583943503, -35725, -2940506, -374603777, -1331267011, -1971504979, 1898648223, -1593072601, -104600630, -77823572, 389420335, -1523611923, 415252167, -597713111, -318869185, -152919553, -147841216, 478215451, -569881040, -535845514, -1054133256, 477345276, -1911424286, -1349862260, -1007161164, -1056986010, 747948105, 1375253925, -1825701889, 867972854, -827645700, -1089855197, -586694401, -400320041, 38265224, 282039315, 178168073, 2088435870, 1072601482, -413696, -1998681, -123193573, 898793979, -1691209767, -863514578, 2021122813, -1296574536, 394641283, -702497568, 510579846, -2036103104, -1574797803, 590152226, 1155465215, -304102943, -16842841, -465674901, 929703360, 666478598, -2059411174, -1344861609, -158768611, -1864792283, 1022628791, -1627304463, -48506337, -1482382340, 1358569446, -1699480011, 482270324, 522243584, 1879912448, -2133999616, 1169228288, 229769273, -405798073, 511028143, -755499606, -18415617, -671973514, 525766053, -849106286, 1639146836, 431538246, -272816081, 340985082, 1805153361, -81899393, -242087364, 1020205539, -497715186, 192889110, -634381603, -16304875, -528849524, 469882081, -2144839275, 875963265, -115552279, -2122726577, -836115588, -1781381897, -2025591569, 2057175039, -1653790730, -1326027268, -1333821252, 1804313835, -837584521, -154182325, 2075965082, 1814862820, -549450565, -33537269, -368665729, -1058789889, 25698244, 515946128, -201195044, -2147054778, -1055514180, 57964541, -559415310, 153466453, -814617762, 1675343343, 257075313, -179377298, -1523712001, 1155098826, -439826667, 126921949, -2085781778, 1833335062, -1485763535, 1698439560, 70254877, -1579076487, -1140808213, 9302741, 7094958, -1954423552, -505976755, -1986034555, 723086239, -316802695, -747340065, 2133016089, -251040641, -299365890, 608509063, -1639261547, 312643486, -1372913665, -389414873, -1639720944, -1073266552, 1250214889, -637964049, -299758658, -1110947876, 1630258662, 352107737, 660335172, 1628011815, 21303653, 71104001, 1016872963, -2108289181, 2013328999, -1874854209, -34058241, 2144288119, -718679553, 551809393, 1205729, 75686656, 83460516, 174653439, 1631026890, -674072578, -1076379075, 2008165888, 1065031180, 225051111, 67173920, 134725723, 32574826, 1912630398, -2130301019, 1680440955, -157548628, -1489114611, 1606320222, 528582146, -1451086112, 2008195081, 1512026112, -539606593, 495747527, -519442438, -218388203, -1521558465, 1853161471, 970387805, 787506085, -1397679037, 17272350, 1068130579, -1308719618, 1816066426, -637012274, -2070762029, 121750245, -199362385, 17536352, 328787460, -1643360201, 134619019, -1071571211, 3470432, 648108803, -1308984069, 737639017, -343934189, -227343975, 1842897852, -659323986, -477560833, -1199396638, -682010808, 62422008, 1736478867, 774925104, 1694051053, 2090709598, -1534989378, 444246509, -89302849, -813785092, 1864630214, 791666910, -910227775, -268378103, 1880082499, -2117858896, 654328494, -1293791508, -1732155359, -1995532054, 200841752, -1896315170, 235431332, 1419182079, 126944001, -1945005629, -1514827625, -314552449, -267546625, 342881736, -83950586, -940531132, 1862436207, 1615211887, 256117232, -39016561, -548881926, 1108320178, 888799210, 1203764848, -1728244281, 1596423189, -68960009, -396878408, -1602157712, 590656528, 2119624198, -1713051135, -1853030401, -1622468897, 2002281791, -783891072, -937678859, -79826438, -2118672202, 867000098, -1380847863, 1119814022, -671963236, 401874177, 2130920451, -384958402, -386132996, -2015265363, -30788209, -60947929, -519094018, -1962836192, 1765166160, 1556447291, 432818177, 1356257819, -1348177933, 612237311, -223556424, 792746026, 152042391, 2102764543, 2067055483, 438642685, -1789689888, 1479538719, -1535188442, 58755328, 583039106, 531169286, 480316430, -723622850, 738344116, -554684490, 1871444926, 1983537135, -2051768544, 970325248, 1340018842, -1554709796, 679542936, -557365783, 1685782527, -1294062310, 1232153717, 719532808, 643739729, 648046307, 1557069821, -143952077, -2064072777, 1464335745, -1477345521, -27172865, -524019747, 353116234, 440410322, 1681921300, 1140850752, 1074271750, -519633737, -798667713, 37920752, -500433240, 2111797588, 511402378, 828162444, -159449089, -1267723135, 1475716402, -1641027531, -3025921, 1452232650, 163999736, 1248329024, -1103112167, -663747980, 539101952, 30246912, 790990139, -170105, 1952933095, -1021967420, -468582737, -504115841, -8622081, -96345140, -1959397676, -1186721190, 1413999843, -2101231185, 864053258, 1770782719, -1965803702, -1659838815, 620787328, 565538656, 1073810884, 148176890, 1827667814, 1560280517, -136840660, -1199658881, -2015712772, 972961667, 281762025, 1029836296, 809628544, 1678654630, 543573728, 14486272, 117534913, -1531773348, -975176822, -339741333, -1610669137, 48793686, 546963455, -754229004, 1096541448, -1685690570, -536499733, -2057247233, 11796473, -930086952, 1140848458, 2145647095, 285145802, 132523808, 2094137369, -1503131072, 469771334, -837545652, 1654480486, 551522811, 846753788, 804192125, -347611201, 557973390, 1616894509, 1583268560, 1322938982, -115802113, 1636912412, 2005419962, -2084438058, 67709112, -1926138478, 1110368984, 912229590, 1539862278, -1182993221, -488899415, 1426602776, 2343557, 8245321, 111904729, 1845620544, -266356921, 67067384, 1919725532, 1219657024, -551368691, 2020074123, -355546865, 1584431631, 265660616, -468516865, -1921940147, 386035072, 343787266, -1565496320, 1575646080, 1266872326, 1588008984, -1702263331, 66068467, 2130818815, -520978435, 535691208, -348655518, -1972693804, 1745911297, 117467906, -1063636969, -1060018994, -1124523856, 1334927122, 42088560, 196040201, -756801335, 162687331, -111476737, -1615791894, 994688381, 483714451, -1110941218, 2142075980, 1472029165, 1203773408, -14550978, -1338031652, 67082753, 1041375503, -142928644, -807598658, 1373765624, -389865787, -1476300272, 10027328, 484076452, 543645820, -1921592288, 111465220, 1329564568, -1619769783, -828562158, -1325596673, -1587144558, 1081329045, 1683818035, -837818561, -41123879, 56405740, -490082250, -835256201, -219152302, 43262976, 1535125507, -1206714306, 223347708, 1417722946, -519770832, -526767073, 1414127892, 1039464899, 1763766273, 731901958, -120520500, 2003845792, -28323728, -1074275216, 1742471167, 1022943069, 431638587, -9802813, -278381049, -8484329, -1205723138, -1643544787, 1286111394, 532678818, -134214049, -1071721496, 569041792, 973764738, -215514375, -758638733, -1492980926, 1090435963, -1612434177, -224256003, 1321263026, 1986929326, -1983938393, -1280870933, -307675781, 1257242623, 79743828, 706075961, -1999078216, 374935443, 518980864, -1176203257, -752221397, 176228853, 1405632299, -7938561, -397826050, -2098331770, 1226252495, 461243333, 448849955, 403780052, 14301088, 814169445, 1578143132, 1105245516, 801575589, -1421847764, 1925687178, 1114768227, -1967063041, 2146334552, -1514002358, -669930218, -241336065, -701911169, 1632346102, 269090785, -1255411142, 1111459216, 16719616, 247089184, -329236480, 191480000, -1816392686, -809458686, 2094577503, -1321996675, 1723751902, 268074521, -235407012, -122217300, -837811244, -162137188, 113551085, 2146893823, -19377116, 604228973, -1444145797, -1113218766, 1985031730, 1184593700, -1062420458, 1873447030, -1499723400, 1719703492, -49446801, -1070594947, 1098909640, 1610743298, -1609567275, 32513892, 263308705, -47537593, -394089865, 1737228776, 360715188, 215206031, 1536711121, -579224424, 1140588543, -725706075, 1858466383, -499022940, 553859105, -206699618, -248997026, -3150089, 184041423, 1875786060, -102378136, -2074310672, 18962688, 203146300, 1318196015, 394835840, -191063561, 266373368, -514157052, -2025387071, 1411636910, 2116031200, -1884570336, -787720930, 1475366611, -746848257, 1250727367, 1224292211, 1061121886, 9624787, 356254077, -1678227078, 1881158990, -2147462900, -563956543, -467920289, -2131502212, 525090809, -9437198, -568494303, -1107303716, 1072737073, -32848339, -1336188860, -1543891950, 1004599250, 1040317253, -234310646, 269570868, 304926097, -1848246273, 1396571107, -612480020, -1174982523, -1661288832, -1611229162, -232306074, 511600664, -602927966, 738273604, 536902958, -2143097864, -75972705, -357828109, 1073717187, 1342175092, 1061106308, 2145228354, 1230297115, 26018542, 1323050419, 58724165, -127893893, 294757102, -85769578, -875036673, -1600532097, -563401817, 1887757767, -1210452003, -833398112, 1793042189, -671184931, -116351379, 1375249364, -706085280, -1144152494, 882594831, -1303301748, -182198589, 527691006, 498147324, 770426054, -473430693, -1091382291, -419718237, 1558378971, 2144197225, 1920944556, 1471367143, 1531576319, -684097182, -1709586355, 331130181, 129962624, 578445552, -1868465081, 1684393979, -658659399, 2147481888, -1241532481, -1065816092, -1752695037, -109588382, -2035938929, 1996016186, 1466435908, -1275047421, -535723910, 16033040, 621289345, -1030817340, 240116391, -541631643, 318432018, 2104885247, -153339279, -136571717, -98929332, 1790957294, 1894055645, 28304810, 1634239715, -1614694897, -1341334980, 32733441, -64390401, -1792143372, 219537127, -16384302, 1925185452, -1340081194, 9057088, 46279681, 2109169813, -786592272, 1368113019, 83141660, -86962768, 1372778558, -180486145, -1251070, 1597466420, -1875827006, 170940702, 1173280299, -1007508267, -1231772471, -584832349, -1785936928, -1863045769, -1614654513, -69211137, -1087301659, -1164837593, 1346343088, 266863496, 385887490, -938817505, 18244410, 1834935109, -75632337, -145557501, 336758399, 725022463, -1084227585, -1335492478, 1733582551, -1005433395, -4802049, -1577386049, -199233538, -89949783, -1241971476, -1472192716, 13648128, 184553533, 1616970070, -2095574028, 1017170254, -603938861, -535824193, -2013399049, -402882564, -540803093, -127938049, -442301593, -878291049, -813971530, -1189664180, -1829896193, 1704541599, -1935497585, -1130169114, -241260797, 989634562, -1681258944, 921945904, -1106401293, -167844002, 515476981, -1122490, -1613277128, -157417470, 2058363913, -645631685, -877655184, 2130714373, 269815816, 1641536, 1550003401, 1241344132, -169633545, 1306491559, 1062154056, 1998389247, 1609747707, 1644473820, -17836740, -542219180, -1752680448, 1172511045, 948075523, -2013020113, 7864626, -2130696949, 2072768455, -707875075, -132030474, 1600093408, 2045837464, -1095033360, -94458093, 1575739521, -397138907, 22683868, 1619525753, -1520424994, 1328406383, 981454935, -1394147329, 1270756359, 1378111169, -188699894, -1525055458, 1888118082, -1903773969, 1593441230, -436207715, -739509109, 1072145353, -38070269, 1816723555, 1120407108, -1912569576, -1203240947, 2089279527, 1089421564, 297586624, 258178051, -978587551, -375439348, -855698988, 1073471692, 1839150401, -637468673, 134767650, -1584976743, 2022884779, 359518751, -1449009156, -1525841955, 541056523, -1497627414, -276790990, 1744835244, 42500540, 2111243151, 1322319868, -642547863, 871332951, -1894272408, 1358801098, 1059149057, -41712001, -325017639, -794952170, 1532606085, 1816443293, 1282537728, 1276444671, -1359369194, -960681304, 1466894005, -3376236, -6652598, 1293336610, -1299708916, 1375764785, 1073751034, 69233188, -2143746776, 100556672, -1206911525, -260063877, -1812238467, -838969449, 2079782452, -1129375137, -1402758153, -564821995, -1616379886, -1735388521, -263511569, 185308551, -292421633, 240397449, -1927189684, -1952858605, -33655313, -1828061703, 1164049008, 851228677, 1967501392, 540115067, 601099232, -5895645, -1323499137, 525340613, -930612203, 285122881, 1474384664, -121757370, 1207658731, -2997681, 212221221, -182462689, -276135207, 1682121082, 152017021, 98303999, 1117128755, 559169557, 1923201404, 151257471, -1730048526, 5554160, 1136132035, 1738537018, -813946361, -2014294360, -168153553, 2139013373, -426631246, 1853935618, -1667497077, -809474568, 941457926, 40468868, 873835756, 364475914, -249372969, -604009016, 352308588, 1205772508, -1690959873, -756578370, -1387006606, -1880441373, 1184267917, 1633135102, -345462481, 1664087345, -68604787, 2071842451, 48526843, -913375562, -608954710, 1875908122, -541355592, 645506799, -564757276, 1002868348, -521603917, 176217462, -583165724, -1495763397, 1576562501, 1595928439, -1767409935, 1861877759, 1523585369, 1469760071, 975940128, -2072946540, 1296216866, 147394386, 168032792, -1449194550, 804354861, -1105227777, -1030117508, 1603176326, 570601644, -1145600110, -1732147445, 1796249497, -265510849, -2037788064, 294924929, -1796195296, 729990032, 142411092, 1888320969, -1073988220, -1851326465, -766612635, 12332933, 799034538, -134468756, -1076059127, -573959615, -1228880567, 1612120236, 267387900, 952784973, 224754496, 764657412, 2024526014, -889845802, -1745747979, -220517157, -539192815, -159178241, -2137158398, -1572167678, 22020225, 58731032, -433078613, -1919140445, -1229324289, -1216418705, -520762813, -941020151, 1507844912, 258888962, 1198309380, -1589633024, 1543766079, 1483, 269512275, -1945658376, -24584385, -328730626, 1248673788, -349438837, -385879359, 1607044608, 2125434899, -520508907, 492830728, 2011169595, 804518662, 943446430, 839808207, -1406140417, -815125321, 1184692175, -1623926858, 2014777409, 493818671, 1783453726, 1769964374, -1073872991, -1614810946, 2088604563, -2032826432, 98999300, 480903178, -1017118090, -1656712663, 1681743375, -636958817, -375189544, 295428075, -2040925605, -21038586, 1872380156, -1342942149, 2135467518, -2022113281, -1955199235, 1352401484, 2127960734, -5945609, 150994560, 103642112, 1941748747, 2072970287, 1643119733, 1057799675, -522115761, -2087792618, -76299906, 645928953, -1669137231, 1208014544, 66625920, -11866097, -522747142, 299762432, 927074374, -806875223, 2077007717, -41837, -1530527745, 1659479124, -142278187, -1613142886, -407594573, -111384339, -246224641, 1868769533, 1633451978, -1089282477, -1576968478, 1881065487, 807272929, 42475264, -2029981172, -899800331, -2098025152, -1075843201, 1568508346, 2146615279, -1088954689, 569433594, -1532010090, 289021634, -2142192418, 86310911, 1856706803, -74760982, -1111729423, 2131425807, -527936770, -340518785, 1883252245, -1273831078, 28716566, 532947534, -124061873, 26144673, 516308997, -1803616216, -1179646717, -956224019, 1629916975, -114733701, -80227333, -876177439, -673956338, 436865530, 473998188, -1058953624, 1257177087, -756751750, 128757303, -783050910, 75344276, 567807168, 2001287759, -1826889700, -2080603719, 1070598471, -33043713, -267690041, -1743357911, 530421384, 403225625, -599752244, -1838486780, 1898688017, 1719308536, -1671671323, -173935786, 1196038653, -469640000, -1850265406, -638906742, 1641676799, -371774333, -41985977, -45748356, 895048390, 1230002143, -302582525, -29160927, -1574960700, 771766363, -520000899, 128793584, -1347952761, 460324850, -887530238, -1679826889, 1038759237, -574072448, -917159527, 1592150013, -317674242, -243249154, 1813101957, 221324827, 134961957, -196542465, -994339904, -1809645, 2061604118, -1690168915, -1274210827, 117057152, 272760834, 1342177282, -2146733628, -2080404128, 2146530814, -1078335536, 2030828043, -1761649736, -817646004, -1283120081, -208042133, -521182731, 1771147777, 1931086838, 161242328, -60259880, 217119, 547254388, 1085800447, 284018348, -201545472, -893598149, -1622651329, -91522353, 2133323699, -394398282, -918565448, -1024447456, -1140732409, -536425860, 14638976, 485681175, -557906568, 1077944309, -1610384391, 8378328, 518870687, -138459649, -180568068, 870825380, -1258301158, 1233415944, -448900974, -1481506817, -1514193489, -428529017, 1092315690, 16043648, 1268768771, -34813889, -1433532420, -1371491373, 940326671, -268374369, -1878553604, 78577648, 659816092, -285281525, 562954909, 284443626, 1250434890, -496815444, 1363414101, -623287073, -366171697, -1349648385, -534596827, -1016134167, 1246822399, -644072880, 1204249687, 45056295, -737528290, 18824352, 576117768, -985792414, 443562390, 1145036861, 805295762, -2779041, -291535105, 1413220862, 1916927909, -1916012846, -1199770445, -2014154288, 1557110023, -778391530, 1500779825, -139460051, 454072964, 213523704, 1318458951, 268763135, -1183720525, -75466283, -992202056, -256854175, 2027013154, 965237304, 731829707, -740847600, 2139030779, -117693187, 1073119171, -28147585, -1380184094, -1207829501, -1069580246, 133432304, 2116055042, -533398516, 290724257, 450962427, 507240437, -496159747, 1811846267, -268509738, -1423638529, -828704899, -1630990004, 584380193, 1097083309, 1229480147, -1842851841, 696318882, -2044203376, -580821589, 1981767279, -235206657, -1084489731, -222480792, 198443953, 1757448224, -2147102103, 2774140, 533057280, 1880489481, 204560065, -1851786437, 2143172955, 1272897541, 1821984962, 1770586111, 242711876, -1292460661, -496879900, 25725328, -1967090388, -183946265, -482648454, -999031835, 990895407, -117715137, -821549060, -253053306, 159376586, -2030107133, 1126287458, 544875473, 93978048, -1071942654, -2111799164, 1654877837, 2123824121, 1996306477, -1445876089, 2069571260, -494338049, -320902027, 1588993433, -502961450, -2035556210, 949373479, -1258368949, -824311312, 1329607973, -150472257, -120288354, -1900815112, -100568114, -285237508, 719978331, 298831990, 1023170045, -699892528, 864777, 1169369759, -426201667, -1526212827, -1605973125, -902773585, 1968224242, -1278214145, 1390862728, -309462493, -1039406785, 774493938, 1363432512, 1105100780, 1766719426, 1479015894, -1459707842, 1274448994, 2010324567, -106825617, -404242061, -1924659258, 1279295086, 1459734971, 2657980, 310699537, -1941524480, -2038209512, -2031350216, -1409608601, 268356939, -1224889039, -199884801, -2056824550, 1550709282, 76674841, -1693148071, 1159168949, 230878815, 548863161, 558364054, 192417468, 1200475881, 939953447, -266926977, 98117248, 1862335622, 1015534143, 544500060, 62642284, 1895034567, -1940669413, 1893106391, 1340212997, -949328328, 529508398, 483906848, 1239089151, 1060152991, 1952577109, 1963963368, 1342196744, 127656641, -1761509353, 2114719807, -134189619, -209658369, -183548801, -5222405, -721029, -109067334, 1359048002, 1535897697, -940045855, 2132810760, 1099079680, -2147024887, 737218280, -998112327, -735002681, -1508251301, -1541627062, 717750271, 1626156467, 66744167, -1053274891, -29040337, -37900034, 1445401419, -98549697, -1140824492, 537041792, 16421544, 1490821375, 157760486, 1372016639, 1388237184, -2032001119, -502299099, -2064817288, 1288403839, -126783810, 123207664, 1875378131, -129792495, 1342183700, 3497840, -135921665, -318694871, -603060088, -404999898, -849079479, 1984270848, -116090873, 132972545, -570830273, -34049953, -7816515, 2063161857, 159354880, -1260584957, 1002446972, -1039179832, 1123668657, 1606864847, -63972097, 1083671540, 516474337, -1970186153, 1040288583, 1946766161, -35783793, -137363457, -372385951, 611310137, -87566408, -2047829982, -1529662976, -1162409846, 874553379, 1854226480, -1069807657, -1555030442, 88866385, 2129567503, -248024065, -17072255, -1041763026, -1485394272, -75222267, -528441317, 552436728, 383069765, 700778171, 1226852227, -1270787843, -1700293089, -831782913, 1427993336, -449151240, 1346726528, 658432, 607895697, 2108170751, -795033611, 1219952601, -756023942, 1493087547, 1032776681, -530940074, 43908344, 653214761, 1405345882, 956056478, 1628595792, 345857, 30429184, 1411212289, 2083304172, -2014135621, 461180851, -881592012, -1886191617, -1068819824, -1605791403, -1014156672, -1605895946, 1347451212, 1595600655, -545289001, -670216889, -1010924004, 2078596112, 1040265399, -793836801, 102772592, 453106694, -2011380410, -505670422, 260495232, 1881568726, 118176012, 1838384403, 884108737, -1557672987, 618177764, -1702971868, 2144272383, 785523396, 1445341760, 688674065, -2103571390, -1871661401, 1494111156, 947252640, -24653800, -931167514, 134077808, 2012963843, 2013773862, 1938915351, -2078272112, -811319671, -1744316616, 1667154646, 2112839617, -1805106966, -1651843038, 1828356711, 1170539234, 2147395316, 1080311562, -1072627713, 1698866554, 25330190, 2055632147, -45744045, -129384449, -1037601410, 116917910, -2138276465, -955621196, -1336522192, -1994772220, 1080971650, -1841050975, -1305491411, 1177710171, -148129585, 1073688319, -1669121, -37257218, 1990419822, -1565004146, -1872185310, -2147479160, 1242107976, -1839529985, 180361604, -610797489, 491463154, 2130689417, 2000014254, 396176125, 896073261, -341796883, -1984913460, 1707990872, -770724545, 1094248430, 119815489, -1056844809, 134265539, -2146015252, 24615928, 677953278, 1531314000, 1110342921, 1677434142, -1745253146, 1329984093, -1358735621, 217841663, 1641880883, 1394937859, 2083904128, 201057920, 260636704, 4980805, 2048588826, 546044293, 739236295, 1648071167, 8091576, 1067055873, 2091384263, -708858172, 2013121280, -1075769593, -8299491, -1073733080, 18350080, 1002604033, 2121117780, -1408948017, 552869846, 1389442357, -378208257, -514452307, -751424833, -1346932225, -1863919575, 1876176387, -719323109, 155849, 67112940, -2063581456, 1426148638, -530970692, 704385, 1957685279, 746529272, -1492898177, -266871297, 48118113, 2123049327, 1915069518, -770473315, -1992490450, 90269853, 146825547, 119241303, -1274609665, 732329179, 549406621, 566295848, -188214797, -1074837311, 1817386876, 629407495, -1475871743, -889813346, -1884417431, 2145982019, -1083114454, 1051378751, -881850390, -1740372356, 537350424, 813694722, 1856055881, 1088932696, 755983234, -641870461, -1350283173, -5776868, 1273425361, 1179975679, 1243545362, 361885617, 930704197, 1945475928, 1043684801, 1916520237, -1856083837, 1542537220, -837809489, -2118111721, 1043300075, -123481732, 1619560422, -712999953, -670309593, 15196160, 242288129, -1894714406, -402255873, -505640492, -604494513, 657404570, 1607602269, 270931517, 284295167, 2006594761, -278191531, 1394697531, 505999152, 518464513, -105889790, 1084416165, -27983819, -2014297286, -1627383810, 472111761, -2139079620, 1034912696, -736166157, 931102260, -537663256, 775888640, -788766649, 941950118, -595324753, -1990196865, 1111517687, -488224597, -1684670240, -1201537025, 1067179514, 2056542285, -1932361245, 1674257743, -1501955103, 462782086, -492974370, 61538242, 2072133135, -138355265, 1057253619, -469656385, -1033238576, 545848610, 1611563304, 15731263, 100991240, 1084723977, -1878885845, 254189919, 1537084382, -1352025590, 2142210555, -930676662, -1101529089, -104745118, 1366683933, -666495884, 2025797598, -1837089276, 766955571, 309240763, 527314018, -353896729, 201117283, -595494349, -1067318769, 30770164, -1644160174, -1144538171, 1345030333, 113487712, 196361488, -1714051964, 765608081, 972560138, -1345499631, -1445918681, -258560547, -1660420097, 453147774, 677484243, 1476283129, -817194373, -1550139032, -1579679703, 184549449, 872421095, 1073922808, 75215796, 937409279, -1356431373, 1317928823, 725604423, 2144856386, 2130337039, -25085209, -770858219, 2055899657, 372900954, -865449916, 1921168366, -251549824, -2109306158, -120782849, -1066607685, 636183286, 1735296511, -1475428890, 1052351509, 45488112, 381714051, -1542588325, -1627959183, 1680861308, 1643431266, 1605762077, -200281753, -1613817735, 668992823, 503869091, -497275073, 903877291, 620050168, 668108416, -1079254983, 747964138, -306307966, 2147300381, 1271529471, -1310352010, 1531343683, 1435187264, 105288802, -2075427576, -692015059, 1571323772, 1300463063, -1696603585, -637789633, 2060762091, -935330049, 25161716, 885259329, -1419779483, 1492685560, 53350912, 70162432, 106340361, -1875181319, -1497825805, 1303084085, 529499472, -1128699800, 2009071615, 1362779660, -1109197088, -854970121, 118284865, -1968241602, -46462745, -1490549761, -129992730, -1165492438, -665686559, -2147354888, -2057019497, -874644640, -192958602, -105929418, 2141038719, -1487792708, 287589344, -1986971135, -831506755, -954204370, 1712990265, -267893532, -1609107258, -1282146305, 258184192, 781622175, 2046092722, -1182003921, -667913569, -896895928, 1242871200, 853917463, 337032849, 83789544, 1911595567, 461579377, -97476732, -1585385415, -1473378461, 1304493455, 1580201919, -487384065, -1087201343, -567281609, 1660295648, -602242750, 359574346, 168831582, -1177812993, -191651534, -773237473, -340106553, -1647447297, -649496618, 1111580956, 275515456, -1138294231, 1078463528, 9072832, 23814144, 50269136, 214662739, 1991239166, 1870628065, -539394337, -83889029, 2004475822, -1410601845, -23265249, 1000341752, -715122554, -315340608, -890881344, 475267071, 978556566, 923274310, 2035871874, 2076359217, 1300963722, -575109535, 878268080, 32356802, -1116275687, -29957121, -168671236, -457637937, -510721537, 445648881, 142637329, 68075539, 555766553, 117588879, 1486356984, 48283392, 510650428, -840172969, -1768070312, 2100745089, 86376447, -255312588, -1286357384, -2043496009, -1528347276, 8734000, 151908205, -1904083035, -2013005652, -2143353918, 12584726, 398645025, -2146549884, 164624528, -58782557, -1142930051, -933874161, 5199537, 41796112, 1063580684, -1154505986, -729348979, -2092952479, -253933640, 1165547067, -1837236225, -1984305012, 642216239, 626759177, -1756295169, -1877421134, -612908768, 547422822, 1189191684, -353451850, -1946272431, 1610082312, -3932158, 854982747, -948922375, 1740660598, -1100218707, -64024561, -1239926917, 1751343113, -2087498840, 104353921, -1124744461, -1206910014, 270669861, 1731461119, -844144365, -1598898660, -1851019207, 1821136216, -1193533821, -1509175291, 520036861, 1743945684, -1825739034, -2126625120, 235145368, 16155652, 39331958, -2034104327, 1275262887, -535889922, 77797996, 1060601227, -3948566, 1227378401, -1328549265, -742550201, 887192894, -2105376493, -1910702081, 1025093121, 2097891304, 605171200, 493880384, -17337856, 1059270665, 226861083, 683934297, -1078977191, -16226305, -65949737, 1413054205, -2088130662, 58980912, -670627949, -2132676024, 371999637, 329408809, -2042674544, 1193412459, -161480161, -173074881, 2113801847, -45677115, -1544814593, -657856505, 874038534, 538218873, -268443144, -781129855, 288314610, 1054619907, 916687886, 3523488, 14417952, 215042093, 1042078205, 866515583, -734003213, 1576665051, 2015880383, 1207894177, 2127683075, -1372917379, 751194121, 1924137637, -2093429942, -486235179, 525062368, -1985806337, 685521339, 148512641, -650645350, -1590338873, -78606264, -965046262, -1480589132, -96437261, -170927337, 2147471199, -944269316, 897478401, 2135547915, -557580171, 633349008, 1778743744, 1077943544, -2134766282, 382550594, 1197570049, 1075707427, -1697427595, 709716659, 1070275375, -1882062849, 1618706265, 1209411039, -1067061485, 2138408543, -46147174, 1605101730, -1812328621, -1409226566, -532807176, 65072704, -131086786, -506175500, 513689506, -645104271, 1463768721, 2387508, 10417216, 247771392, -101989857, -1074249089, 1912479155, -1582606413, 126089464, -1869981451, 784138239, 2043335355, -424097997, -87987807, -38988801, 14294944, 244507776, 248559111, -1671439766, 1346028502, 47515780, 1875134527, -62927876, 1161846627, -920155154, 571522779, 879934, 16768936, -1612210492, -1111541297, 1341671552, -1485606372, 131791365, -67700786, -2038658020, -58130433, 801085515, -1988783069, -629461016, 871974208, 925215888, -800063468, 76023934, 1499988948, 2130728763, -66517889, -230482945, -322699784, -263192595, 297795392, -956321220, 536557217, -33479148, 524962816, -909729558, -2103902047, 1548485093, -1969619746, -771362733, 1168052139, 1281097727, 28139397, 259834177, -1806784843, -875488933, -1293781137, 977319871, 226502715, -936338180, -1954293493, -936432071, -2022943361, 1276182521, -441975783, 1123534089, 1224232966, 1847563537, 1106833726, 802239397, -64762001, -517440388, -1697852432, 973057789, 1256741161, -2013264730, 1378942975, -2016124141, 2053114444, -736467681, 1258576029, -935006337, 1154218976, 276811396, -1812454895, -544352421, -264367562, 100057616, 2080539143, -1156546438, 1419218937, 517537424, 1057996693, 1102974798, 938156356, -284416262, 459803677, 735995969, -1867821044, 100410257, 1884871464, 308477951, 1664844106, 82550466, -733166480, -2102963495, -775148551, -548507650, -787759118, 377481130, -1748549636, -869014148, 1081980836, 214886528, 1432479559, 1762344980, -2043608383, 2055214179, -50260529, 1417356760, 248028227, -1220373363, -943423498, -1974734933, -1299717278, 408446094, 1183842303, -2134580542, 1376378117, 1923353725, -2104639223, 1588413648, 910807039, -560998242, -2114840591, 528552673, -116329796, 470306311, 408994043, -1551073434, 1829501986, 16711720, 1207307449, 1050973955, 1847577152, -547421823, -536041425, 768509282, 365705627, 1744026877, -1561599078, 140902399, 2065242316, -916492866, 997504214, -2024683433, -30051649, 1882099326, 1591751839, -1441949322, 561121918, -695915637, 1987768431, -8637190, 1698238371, -517674894, 1849826606, -2012704627, -2129503403, 1008865145, -1973658200, 124845639, -3033012, 1515229545, 1312214770, 1364962295, 1215692799, 889211454, 1856263267, 1089504737, 288346880, -1812983553, -18669306, -366539836, -1761912383, -35819511, -1213229187, 2042279295, 160097200, 1046675457, -1761517453, -1342139752, 35832440, 436279098, -1263462673, 13647828, -2051293192, -1506803831, 578787880, 296699424, -866329040, -1067909121, -1579067542, -478172826, 1770624606, 1036239176, -280521973, -541014001, -1356332995, -1629355036, 1224760872, 11458, 134280380, 19034048, 581040429, 1555791926, -1419018271, 1556083862, -1976597725, -17051980, -158728205, -1200766700, 1931348118, -1522138091, -2004865189, 101096944, 499777535, -279785711, -78441562, 817633447, 49219584, 2080612354, -48234425, -1291091236, 1123822047, 1608584251, -31373441, -128698393, -161318756, 903423467, -1983825503, 1352609002, 289447040, -16209909, -1197813268, -1964635153, 631523475, -366352938, 214763427, -667754199, -544698317, 768540671};
#pragma HLS array_partition variable=fc1w cyclic factor=25

	// For next packing
	bool activation1[BATCH_SIZE*128];
#pragma HLS array_partition variable=activation1 cyclic factor=32

	// Layer 1
	for (int i=0; i<BATCH_SIZE; i++){ // iter: 64
		for (int j=0; j<128; j++){ // iter: 128
#pragma HLS PIPELINE
			int neg_cnt = 0;
			for (int k=0; k<24; k++){ // iter: 24 (except 1)
#pragma HLS UNROLL
				D_TYPE result = (X0[i*25+k]^fc1w[j*25+k]);

				split_32 converter;
				converter.value = result;

				neg_cnt += pop_count1[converter.splited[0]]+ pop_count1[converter.splited[1]]+ pop_count1[converter.splited[2]]+ pop_count1[converter.splited[3]];
			}

			// 25th -> only 16
			D_TYPE result = (X0[i*25+24]^fc1w[j*25+24]);

			split_32 converter;
			converter.value = result;

			neg_cnt += pop_count1[converter.splited[2]] + pop_count1[converter.splited[3]];

			// Activation & Packing for next
			// neg_cnt of 784
			activation1[i*128+j] = neg_cnt >= 392;
		}
	}


	D_TYPE X1[BATCH_SIZE*4];
#pragma HLS array_partition variable=X1 cyclic factor=4

	for (int i=0; i<BATCH_SIZE*128; i+=32){
#pragma HLS PIPELINE
		D_TYPE next_buf = 0;
		for (int j=0; j<32; j++){
#pragma HLS UNROLL
			if (activation1[i+j]){ // negative => -1 => 1
				next_buf = next_buf+1;
			}
			else {  // positive => 1 => 0
				next_buf = next_buf&0xFFFFFFFE;
			}
			if (j!=31) next_buf = (next_buf << 1) & 0xFFFFFFFF;
		}

		X1[int(i/32)] = next_buf;
	}

	const char pop_count2[256] = {0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 4, 5, 5, 6, 5, 6, 6, 7, 5, 6, 6, 7, 6, 7, 7, 8};
	bool activation2[BATCH_SIZE*64];
#pragma HLS array_partition variable=activation2 cyclic factor=32

	static const int fc2w[256] = {1913607555, 675556588, -392329988, 1303398415, -1490125702, 62821375, -542347646, 1301598150, 1163584328, -29832405, -1272680188, -1162988570, 1516751550, 134025714, 885159778, -1830645916, 1670071650, -1853736550, 794745561, -190761671, -115855289, 865261520, -506592237, 1356175475, 1809872467, 89552368, 327364120, 1373068290, 91433726, -1843467187, -1232488694, -1856812947, 1458045321, -1941018636, 1085376585, 1847209367, 1370462392, -131789395, 1701906789, 994932115, -514003090, 302547670, -64212302, 1139741624, 1554601670, 623363906, -1063679391, -124568297, 1177626952, -998284857, 2132777473, -566074479, -1708813692, 1876409896, 1065569102, -2093622046, 2139866858, -599529102, -78922416, -1074178407, -113155865, 568391238, -1946517405, 1543870467, -1747981241, 1925106304, -243372465, 1305810384, 1769867609, -186619754, 1759092965, -1108859413, -670728397, 1873397934, 2059953011, 1017438790, -2146408123, 1954170829, 1144882157, 1624539516, 72660996, -1465228087, 942706951, 1110033140, 1862526707, -1808418821, 852223390, 1136003666, 536278645, 1169691875, -1634569657, 343509589, -1221697945, 163158029, 853623591, 788913768, 266075963, -99245270, -788079860, -957917240, -1875378756, -432231379, -1962606706, 54314960, -1873536626, 1156203296, -326728567, 1086310395, 1719888282, -1774047823, -592490840, 1847752155, -106863545, 1135956566, -237085157, -530738976, 364679443, -87245251, -1976119859, -1296984784, 405249755, 124701709, 13716262, -385030038, -1294948539, 396915666, 1595809361, 549834802, -1223963018, -1477133889, -1334811890, -1620200896, -1624799408, -235995825, 302590126, 832670055, -1204773117, -507192251, 1191020863, -316325849, -291388173, 339879025, 529708558, -249352907, 68264426, 2083714410, 386763475, -1192028269, -1304224025, 51485689, -205437890, -844310590, 1872856307, -1921850169, 315820050, 1413587465, -660824378, 2023872803, -336375326, -185805242, -2126700285, 1720749864, -284186189, -1588575269, 1287422625, 2020402209, 1172932967, -1154125126, -1113133580, -779580233, 902329218, 516563773, 1355577761, -2095635814, -508647996, 234652095, 1808430298, 67306230, 1019674352, 1851951487, 1749701575, -1765325870, 1809321717, -195978923, -443159796, 1446239531, -868000310, 234461146, 116664680, 608072293, 513652749, -1571272452, -785682493, 1134877983, 1793147235, 251977801, -775379398, -744168125, -1023040110, 1859475266, 2127518835, -96310634, 399966931, 2080521605, 93383004, 2015549006, 394068881, 1645158717, 1352494397, -99832944, -918639247, 620668167, -1815595709, -96922792, -108102542, 110954578, -1369206086, -2044932147, 256494606, -281845230, 1188790555, -128816218, 288142804, -270851073, -526341626, 196671304, 1185480894, -456299853, 203489452, -1099468722, 1593643840, -372544051, -132046579, 1865311560, -861134079, 1080016947, -244675706, 1386596426, -311426045, 681001478, 1217831424, 1622079496, -1023836047, -1189752093, 1599237581, -374275372, -40717214, 1090355694, 1121819433, -1396674637, -902046527, 650302863, -1309918451, 1650989621, -167048699, 135186123};
#pragma HLS array_partition variable=fc2w cyclic factor=4


	// Layer 2
	for (int i=0; i<BATCH_SIZE*4; i+=4)
	{
		for (int j=0; j<256; j+=4)
		{
#pragma HLS PIPELINE
			int neg_cnt = 0;
			for (int k=0; k<4; k++){
#pragma HLS UNROLL
				D_TYPE result = (X1[i+k]^fc2w[j+k]); // nor

				split_32 converter;
				converter.value = result;

				neg_cnt += pop_count2[converter.splited[0]]+ pop_count2[converter.splited[1]]+ pop_count2[converter.splited[2]]+ pop_count2[converter.splited[3]];
			}

			// Activation & Packing for next
			// neg_cnt of 128
			activation2[int(i/4)*64+int(j/4)] = neg_cnt >= 64;
		}
	}
	D_TYPE X2[BATCH_SIZE*2];
#pragma HLS array_partition variable=X2 cyclic factor=20

	// For next packing
	for (int i=0; i<BATCH_SIZE*64; i+=32){
#pragma HLS PIPELINE
		D_TYPE next_buf = 0;
		for (int j=0; j<32; j++){
#pragma HLS UNROLL
			if (activation2[i+j]){ // negative => -1 => 1
				next_buf = next_buf+1;
			}
			else {  // positive => 1 => 0
				next_buf = next_buf&0xFFFFFFFE;
			}
			if (j!=31) next_buf = (next_buf << 1) & 0xFFFFFFFF;
		}

		X2[int(i/32)] = next_buf;
	}


	const char pop_count3[256] = {0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 1, 2, 2, 3, 2, 3, 3, 4, 2, 3, 3, 4, 3, 4, 4, 5, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 2, 3, 3, 4, 3, 4, 4, 5, 3, 4, 4, 5, 4, 5, 5, 6, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 3, 4, 4, 5, 4, 5, 5, 6, 4, 5, 5, 6, 5, 6, 6, 7, 4, 5, 5, 6, 5, 6, 6, 7, 5, 6, 6, 7, 6, 7, 7, 8};
//	bool activation3[64*10] = {};
	static const int fc3w[20] = {-396171820, -453312752, 1999377659, 478627577, -1684388720, 437068610, -826714611, 2057174436, 897088322, -496922371, 1579394953, -2059473899, -754704442, -262077952, 754882725, 164846975, -1906367093, -12131624, -2099939038, 626363423};
#pragma HLS array_partition variable=fc3w cyclic factor=2

	// Layer 3
	for (int i=0; i<BATCH_SIZE*2; i+=2)
	{

		for (int j=0; j<10*2; j+=2)
		{
#pragma HLS PIPELINE
			int neg_cnt = 0;
			for (int k=0; k<2; k++){
#pragma HLS UNROLL
				D_TYPE result = (X2[i+k]^fc3w[j+k]); // nor

				split_32 converter;
				converter.value = result;

				neg_cnt += pop_count3[converter.splited[0]]+ pop_count3[converter.splited[1]]+ pop_count3[converter.splited[2]]+ pop_count3[converter.splited[3]];
			}

			// Activation & Packing for next :: 64
			X3[int(i/2)*10+int(j/2)] = 64-(2*neg_cnt);
		}
	}
}

void numpy_network(AXI_VAL *IN, AXI_VAL *OUT)
{
#pragma HLS INTERFACE axis port = IN depth=8192
#pragma HLS INTERFACE axis port = OUT depth=8192

#pragma HLS INTERFACE ap_ctrl_none port=return
//#pragma HLS dataflow
	D_TYPE IN_ARR[BATCH_SIZE*25];
#pragma HLS array_partition variable=IN_ARR cyclic factor=25

	D_TYPE OUT_ARR[BATCH_SIZE*10];
#pragma HLS array_partition variable=OUT_ARR cyclic factor=2

//#pragma HLS ARRAY_PARTITION variable=A_ARR cyclic factor = 8
//#pragma HLS ARRAY_PARTITION variable=B_ARR cyclic factor = 8

	load(IN_ARR, IN);

	network(IN_ARR, OUT_ARR);

	store(OUT, OUT_ARR);
}
